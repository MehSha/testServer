version: 2
jobs:
  build:
    working_directory: /tmp/workspace
    docker:
     - image: circleci/golang
    steps:
      - checkout
      - setup_remote_docker
      - run: docker build -t mehryaar/testserver -f /tmp/workspace/Dockerfile /tmp/workspace/

  build_push:
    working_directory: /tmp/workspace
    docker:
     - image: circleci/golang
    steps:
      - checkout
      - setup_remote_docker
      - run: docker build -t mehryaar/testserver -f /tmp/workspace/Dockerfile /tmp/workspace/
      - run: docker login -u $DOCKER_USER -p $DOCKER_PASS
      - run: docker push mehryaar/testserver
  
  test:
    docker:
     - image: circleci/golang
    steps:
      - checkout
      - run: go vet
      - setup_remote_docker
      # - run:
      #     name: Install Docker Compose
      #     command: |
      #       curl -L https://github.com/docker/compose/releases/download/1.23.2/docker-compose-`uname -s`-`uname -m` > ~/docker-compose
      #       chmod +x ~/docker-compose
      #       sudo mv ~/docker-compose /usr/local/bin/docker-compose
      - run:
          name: run tests
          command: |
            set -x
            docker-compose -f docker-compose.test.yml up --build -d
            docker-compose -f docker-compose.test.yml run app go test -tags integration -v
            docker-compose -f docker-compose.test.yml down
 
  report:
    docker: # use the docker executor type; machine and macos executors are also supported
     - image: mehryaar/runner_sloc
    steps:
      - checkout
      - run: /go/bin/sloc .

workflows:
  version: 2
  all:
    jobs:
      - test
      - report
      - build_push:
          context: tokens
          requires:
            - test

